<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Data Transformation</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        /* Loading overlay styles */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255,255,255,0.7);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        #loadingOverlay .spinner-border {
            width: 4rem;
            height: 4rem;
        }
        .container {
            max-width: 1200px;
            margin-top: 30px;
        }
        .card {
            margin-bottom: 20px;
        }
        .result-section {
            margin-top: 30px;
            display: none;
        }
        .table-responsive {
            max-height: 400px;
        }
        .spinner-border {
            display: none;
            margin-right: 10px;
        }
        .column-checkbox {
            margin-right: 10px;
        }
        .transformation-row {
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            position: relative;
        }
        .remove-transformation {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            color: red;
        }
        .add-transformation-btn {
            margin-bottom: 20px;
        }
        .available-columns {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
        }
        .drag-drop-area {
            min-height: 100px;
            border: 2px dashed #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .column-pill {
            display: inline-block;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 15px;
            padding: 2px 10px;
            margin: 2px;
            cursor: move;
        }
        .column-list {
            min-height: 30px;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div class="container">
        <h1 class="mb-4">Excel Data Transformation</h1>
        <div class="mb-4">
            <a href="/api/transform/generate-journal" class="btn btn-primary" download>
                Download Journal File
            </a>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>Select Excel File for Column Combination</h5>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="fileSelect">Select Excel File:</label>
                    <select class="form-control" id="fileSelect">
                        <option value="">-- Select File --</option>
                    </select>
                </div>
                
                <div id="sheetSelectDiv" style="display: none;">
                    <div class="form-group">
                        <label for="sheetSelect">Select Sheet:</label>
                        <select class="form-control" id="sheetSelect">
                            <option value="">-- Select Sheet --</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="transformationCard" class="card" style="display: none;">
            <div class="card-header">
                <h5>Configure Column Combinations</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>Available Columns</h6>
                        <div id="availableColumnsContainer" class="available-columns">
                            <!-- Available columns will be shown here as draggable items -->
                            <div class="text-muted">Select a sheet to see available columns</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="outputFileName">Output File Name:</label>
                            <input type="text" class="form-control" id="outputFileName" placeholder="Enter output file name">
                        </div>
                        
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="includeOriginalColumns">
                            <label class="form-check-label" for="includeOriginalColumns">Include original columns in output</label>
                        </div>
                    </div>
                </div>
                
                <h5>Column Transformations</h5>
                <div id="transformationsContainer">
                    <!-- Transformation rows will be added here -->
                </div>
                
                <button id="addTransformationBtn" class="btn btn-info add-transformation-btn">
                    <i class="fa fa-plus"></i> Add Another Transformation
                </button>
                
                <hr>
                
                <button id="transformBtn" class="btn btn-primary">
                    <span class="spinner-border spinner-border-sm" id="transformSpinner"></span>
                    Generate Transformed Excel
                </button>
            </div>
        </div>
        
        <div id="resultSection" class="result-section">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5>Transformation Result</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-success">
                        <strong>Success!</strong> <span id="resultMessage"></span>
                    </div>
                    
                    <h6>Transformation Summary:</h6>
                    <ul id="transformationSummary">
                        <!-- Summary will be added here -->
                    </ul>
                    
                    <h6>Sample of Transformed Data:</h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead id="resultTableHead">
                                <!-- Headers will be added here -->
                            </thead>
                            <tbody id="resultTableBody">
                                <!-- Data rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <a id="downloadLink" class="btn btn-success" target="_blank">
                            Download Transformed Excel
                        </a>
                        <a href="/api/transform/generate-journal" class="btn btn-primary" download>
                            Download Journal File
                        </a>
                        <a href="/excel" class="btn btn-secondary ml-2">Back to Dashboard</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script>
        $(document).ready(function() {
            // Initialize global variables
            window.availableColumns = [];
            window.transformationCounter = 0;
            
            // Load available Excel files
            loadExcelFiles();
            
            // File selection event
            $("#fileSelect").change(function() {
                const selectedFile = $(this).val();
                if (selectedFile) {
                    loadSheets(selectedFile);
                    
                    // Set default output filename based on input file
                    const baseName = selectedFile.substring(0, selectedFile.lastIndexOf('.'));
                    $("#outputFileName").val(baseName + "_transformed.xlsx");
                } else {
                    $("#sheetSelectDiv").hide();
                    $("#transformationCard").hide();
                }
            });
            
            // Sheet selection event
            $("#sheetSelect").change(function() {
                const selectedSheet = $(this).val();
                if (selectedSheet) {
                    loadSheetColumns();
                } else {
                    $("#transformationCard").hide();
                }
            });
            
            // Add transformation button click
            $("#addTransformationBtn").click(function() {
                addNewTransformationRow();
            });
            
            // Transform button click
            $("#transformBtn").click(function() {
                createTransformedExcel();
            });
            
            // Initialize sortable for drag-drop functionality
            initializeDragDrop();
        });
        
        function initializeDragDrop() {
            // Enable drag and drop between transformation rows
            $(document).on('dragstart', '.column-pill', function(e) {
                e.originalEvent.dataTransfer.setData('text/plain', $(this).data('column'));
            });
        }
        
        function showLoading() {
            $("#loadingOverlay").show();
        }
        function hideLoading() {
            $("#loadingOverlay").hide();
        }

        function loadExcelFiles() {
            showLoading();
            $.ajax({
                url: "/api/excel/files",
                type: "GET",
                success: function(data) {
                    $("#fileSelect").empty();
                    $("#fileSelect").append('<option value="">-- Select File --</option>');
                    data.forEach(function(fileName) {
                        $("#fileSelect").append(`<option value="${fileName}">${fileName}</option>`);
                    });
                    hideLoading();
                },
                error: function(xhr) {
                    hideLoading();
                    alert("Error loading Excel files: " + xhr.responseText);
                }
            });
        }
        
        function loadSheets(fileName) {
            showLoading();
            $.ajax({
                url: `/api/excel/extract/${fileName}`,
                type: "GET",
                success: function(data) {
                    $("#sheetSelect").empty();
                    $("#sheetSelect").append('<option value="">-- Select Sheet --</option>');
                    if (data.sheetNames && data.sheetNames.length > 0) {
                        data.sheetNames.forEach(function(sheetName) {
                            $("#sheetSelect").append(`<option value="${sheetName}">${sheetName}</option>`);
                        });
                        $("#sheetSelectDiv").show();
                    } else {
                        alert("No sheets found in the selected file.");
                    }
                    hideLoading();
                },
                error: function(xhr) {
                    hideLoading();
                    alert("Error loading sheets: " + xhr.responseText);
                }
            });
        }
        
        function loadSheetColumns() {
            const fileName = $("#fileSelect").val();
            const sheetName = $("#sheetSelect").val();
            if (!fileName || !sheetName) return;
            showLoading();
            $.ajax({
                url: `/api/excel/extract/${fileName}/${sheetName}`,
                type: "GET",
                success: function(data) {
                    if (data && data.length > 0) {
                        // Get column names from the first row
                        const columns = Object.keys(data[0].data);
                        window.availableColumns = columns;
                        // Populate available columns container
                        $("#availableColumnsContainer").empty();
                        columns.forEach(function(column) {
                            $("#availableColumnsContainer").append(`
                                <div class="column-pill" draggable="true" data-column="${column}">
                                    ${column}
                                </div>
                            `);
                        });
                        // Clear any existing transformations
                        $("#transformationsContainer").empty();
                        window.transformationCounter = 0;
                        // Add initial transformation row
                        addNewTransformationRow();
                        $("#transformationCard").show();
                    } else {
                        alert("No data found in the selected sheet.");
                    }
                    hideLoading();
                },
                error: function(xhr) {
                    hideLoading();
                    alert("Error loading sheet data: " + xhr.responseText);
                }
            });
        }
        
        function addNewTransformationRow() {
            const rowId = "transformation_" + (++window.transformationCounter);
            const dropAreaId = "dropArea_" + window.transformationCounter;
            const selectedColumnsId = "selectedColumns_" + window.transformationCounter;
            
            const transformationRow = `
                <div id="${rowId}" class="transformation-row">
                    <span class="remove-transformation" onclick="removeTransformation('${rowId}')">&times;</span>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Source Columns (drag columns here):</label>
                                <div id="${dropAreaId}" class="drag-drop-area" ondrop="drop(event, '${selectedColumnsId}')" ondragover="allowDrop(event)">
                                    <div id="${selectedColumnsId}" class="column-list">
                                        <!-- Selected columns will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>New Column Name:</label>
                                <input type="text" class="form-control target-column" placeholder="Enter new column name">
                            </div>
                            
                            <div class="form-group">
                                <label>Separator (optional):</label>
                                <input type="text" class="form-control separator" placeholder="Leave empty for no separator">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $("#transformationsContainer").append(transformationRow);
        }
        
        function removeTransformation(rowId) {
            $("#" + rowId).remove();
        }
        
        function allowDrop(ev) {
            ev.preventDefault();
        }
        
        function drop(ev, targetId) {
            ev.preventDefault();
            const columnName = ev.dataTransfer.getData("text/plain");
            
            if (columnName) {
                $(`#${targetId}`).append(`
                    <div class="column-pill" draggable="true" data-column="${columnName}">
                        ${columnName}
                        <span class="ml-1" onclick="$(this).parent().remove();">&times;</span>
                    </div>
                `);
            }
        }
        
        function getTransformationData() {
            const transformations = {};
            const separators = {};
            
            $(".transformation-row").each(function() {
                const targetColumn = $(this).find(".target-column").val();
                const separator = $(this).find(".separator").val();
                
                if (targetColumn) {
                    // Get all column pills in this transformation
                    const sourceColumns = [];
                    $(this).find(".column-pill").each(function() {
                        sourceColumns.push($(this).data("column"));
                    });
                    
                    if (sourceColumns.length > 0) {
                        transformations[targetColumn] = sourceColumns;
                        separators[targetColumn] = separator || "";
                    }
                }
            });
            
            return {
                transformations: transformations,
                separators: separators
            };
        }
        
        function createTransformedExcel() {
            const fileName = $("#fileSelect").val();
            const outputFileName = $("#outputFileName").val();
            const includeOriginalColumns = $("#includeOriginalColumns").is(":checked");
            // Get all transformations
            const transformationData = getTransformationData();
            if (Object.keys(transformationData.transformations).length === 0) {
                alert("Please configure at least one column transformation.");
                return;
            }
            if (!outputFileName) {
                alert("Please enter a name for the output file.");
                return;
            }
            showLoading();
            $("#transformBtn").prop("disabled", true);
            $("#transformSpinner").show();
            const requestData = {
                transformations: transformationData.transformations,
                separators: transformationData.separators,
                outputFileName: outputFileName,
                includeOriginalColumns: includeOriginalColumns
            };
            $.ajax({
                url: `/api/excel/transform/file/${fileName}/create-excel`,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(requestData),
                success: function(response) {
                    $("#transformBtn").prop("disabled", false);
                    $("#transformSpinner").hide();
                    hideLoading();
                    if (response.success) {
                        displayTransformationResult(response);
                    } else {
                        alert("Transformation failed: " + response.error);
                    }
                },
                error: function(xhr) {
                    $("#transformBtn").prop("disabled", false);
                    $("#transformSpinner").hide();
                    hideLoading();
                    alert("Error during transformation: " + xhr.responseText);
                }
            });
        }
        
        function displayTransformationResult(response) {
            // Show success message
            $("#resultMessage").text(`Created transformed Excel file "${response.fileName}" with ${response.transformationCount} column transformations.`);
            
            // Create transformation summary
            let summaryHtml = "";
            summaryHtml += `<li>Source file: ${response.sourceFile}</li>`;
            summaryHtml += `<li>Output file: ${response.fileName}</li>`;
            summaryHtml += `<li>Transformations: ${response.transformationCount}</li>`;
            summaryHtml += `<li>Records processed: ${response.recordCount}</li>`;
            
            $("#transformationSummary").html(summaryHtml);
            
            // Set download link
            $("#downloadLink").attr("href", `/excel/temp/${response.fileName}`);
            
            // Show result section
            $("#resultSection").show();
        }
    </script>
</body>
</html>
